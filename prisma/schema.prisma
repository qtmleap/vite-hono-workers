// Prismaスキーマ for Cloudflare D1
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// イベント配布条件
model EventCondition {
  id             String   @id @default(uuid())
  eventId        String   @map("event_id")
  /// 配布条件の種類: purchase, first_come, lottery, everyone
  type           String
  /// 購入条件の場合の金額（円）
  purchaseAmount Int?     @map("purchase_amount")
  /// 先着または抽選の人数
  quantity       Int?
  /// 作成日時
  createdAt      DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt      DateTime @updatedAt @map("updated_at")
  event          Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_conditions")
}

/// イベント参考URL
model EventReferenceUrl {
  id        String   @id @default(uuid())
  eventId   String   @map("event_id")
  /// URLの種類: announce, start, end
  type      String
  url       String
  /// 作成日時
  createdAt DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt DateTime @updatedAt @map("updated_at")
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_reference_urls")
}

/// イベント開催店舗（中間テーブル）
model EventStore {
  id        String   @id @default(uuid())
  eventId   String   @map("event_id")
  storeKey  String   @map("store_key")
  /// 作成日時
  createdAt DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt DateTime @updatedAt @map("updated_at")
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, storeKey])
  @@index([eventId])
  @@map("event_stores")
}

/// イベント
model Event {
  id              String              @id @default(uuid())
  /// イベント種別: limited_card, regular_card, ackey, other
  category        String
  /// イベント名
  name            String
  /// 限定数（任意）
  limitedQuantity Int?                @map("limited_quantity")
  /// 開始日時
  startDate       DateTime            @map("start_date")
  /// 終了予定日時（任意）
  endDate         DateTime?           @map("end_date")
  /// 実際の終了日時（任意、配布が終了した実際の日時）
  endedAt         DateTime?           @map("ended_at")
  /// 作成日時
  createdAt       DateTime            @default(now()) @map("created_at")
  /// 更新日時
  updatedAt       DateTime            @updatedAt @map("updated_at")
  /// 配布条件
  conditions      EventCondition[]
  /// 参考URL
  referenceUrls   EventReferenceUrl[]
  /// 開催店舗
  stores          EventStore[]

  @@map("events")
}

/// キャラクター投票
model Vote {
  id          String   @id @default(uuid())
  /// キャラクターID（例: biccame-001）
  characterId String   @map("character_id")
  /// 投票者のIPアドレス
  ipAddress   String   @map("ip_address")
  /// 投票日時
  createdAt   DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([characterId])
  @@index([ipAddress, characterId])
  @@index([createdAt])
  @@map("votes")
}

/// キャラクター投票集計
model VoteCount {
  /// キャラクターID（例: biccame-001）
  characterId String   @map("character_id")
  /// 年度（例: 2025, 2026）
  year        Int
  /// 累計投票数
  count       Int      @default(0)
  /// 投票日時
  createdAt   DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@id([characterId, year])
  @@map("vote_counts")
}
